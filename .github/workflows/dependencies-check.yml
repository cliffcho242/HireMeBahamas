name: Dependency Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

# Set default permissions to read-only
permissions:
  contents: read

jobs:
  check-python-dependencies:
    name: Check Python Dependencies
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      actions: read
      pull-requests: write  # For commenting on PRs
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check Python dependencies
        id: check-deps
        run: |
          python scripts/check_dependencies.py
        continue-on-error: true
      
      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: dependency_check_report.json
          retention-days: 30
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.check-deps.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = {};
            try {
              report = JSON.parse(fs.readFileSync('dependency_check_report.json', 'utf8'));
            } catch (error) {
              console.log('Could not read dependency report');
              return;
            }
            
            const missing = report.missing_dependencies || [];
            const warnings = report.warnings || [];
            
            let comment = '## ‚ö†Ô∏è Dependency Check Failed\n\n';
            
            if (missing.length > 0) {
              comment += '### Missing Dependencies\n';
              missing.forEach(dep => {
                comment += `- ‚ùå ${dep}\n`;
              });
              comment += '\n';
            }
            
            if (warnings.length > 0) {
              comment += '### Warnings\n';
              warnings.forEach(warning => {
                comment += `- ‚ö†Ô∏è ${warning}\n`;
              });
              comment += '\n';
            }
            
            comment += '### üí° How to Fix\n';
            comment += '1. Run `python scripts/activate_all_dependencies.py`\n';
            comment += '2. Run `python scripts/check_dependencies.py` to verify\n';
            comment += '3. Commit any changes to requirements.txt\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  check-frontend-dependencies:
    name: Check Frontend Dependencies
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      actions: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Check frontend dependencies
        id: check-frontend
        run: |
          cd frontend
          node scripts/validate-deps.js
        continue-on-error: true
      
      - name: Upload frontend report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-dependency-report
          path: frontend_dependency_report.json
          retention-days: 30
      
      - name: Check TypeScript compilation
        run: |
          cd frontend
          npm run build
        continue-on-error: true

  test-integrations:
    name: Test Service Integrations
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      actions: read
    
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Test Redis connection
        env:
          REDIS_URL: redis://localhost:6379
        run: |
          python -c "
          import redis
          r = redis.from_url('redis://localhost:6379')
          r.ping()
          print('‚úÖ Redis connection successful')
          "
      
      - name: Test PostgreSQL connection
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          python -c "
          import psycopg2
          conn = psycopg2.connect('postgresql://test_user:test_password@localhost:5432/test_db')
          conn.close()
          print('‚úÖ PostgreSQL connection successful')
          "
      
      - name: Run full dependency check with services
        env:
          REDIS_URL: redis://localhost:6379
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          python scripts/check_dependencies.py

  security-check:
    name: Security Vulnerability Check
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      actions: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install safety
      
      - name: Run safety check
        run: |
          safety check --json || true
        continue-on-error: true

  report-status:
    name: Report Overall Status
    runs-on: ubuntu-latest
    needs: [check-python-dependencies, check-frontend-dependencies, test-integrations]
    if: always()
    
    permissions:
      contents: read
    
    steps:
      - name: Check job statuses
        run: |
          echo "Python Dependencies: ${{ needs.check-python-dependencies.result }}"
          echo "Frontend Dependencies: ${{ needs.check-frontend-dependencies.result }}"
          echo "Integration Tests: ${{ needs.test-integrations.result }}"
          
          if [[ "${{ needs.check-python-dependencies.result }}" == "failure" ]] || \
             [[ "${{ needs.check-frontend-dependencies.result }}" == "failure" ]] || \
             [[ "${{ needs.test-integrations.result }}" == "failure" ]]; then
            echo "‚ùå Dependency check failed"
            exit 1
          else
            echo "‚úÖ All dependency checks passed"
          fi
