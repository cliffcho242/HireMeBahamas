name: Deploy Database Schema

# This workflow deploys the database schema using Drizzle Kit
# Can be run manually or triggered on schema changes

on:
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: 'development'
  
  # Trigger on schema changes
  push:
    branches:
      - main
    paths:
      - 'next-app/lib/schema.ts'
      - 'next-app/drizzle.config.ts'

jobs:
  deploy-schema:
    runs-on: ubuntu-latest
    
    # Explicit GITHUB_TOKEN permissions for security
    permissions:
      contents: read
      actions: read
    
    # Only run on main branch or manual trigger
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    environment:
      name: ${{ github.event.inputs.environment || 'development' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: next-app/package-lock.json

      - name: Install dependencies
        working-directory: next-app
        # Note: --legacy-peer-deps is required due to React 19 peer dependency
        # conflict with lucide-react. This is a known issue and will be resolved
        # when lucide-react updates to support React 19.
        run: npm ci --legacy-peer-deps

      - name: Verify schema file exists
        working-directory: next-app
        run: |
          if [ ! -f "lib/schema.ts" ]; then
            echo "âŒ Error: Schema file not found at lib/schema.ts"
            exit 1
          fi
          echo "âœ… Schema file verified"

      - name: Generate migration preview
        working-directory: next-app
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
        run: |
          echo "ðŸ“ Generating migration preview..."
          npm run db:generate
          
          if [ -d "drizzle" ]; then
            echo ""
            echo "ðŸ“„ Generated migration files:"
            ls -lh drizzle/*.sql 2>/dev/null || echo "No SQL files generated"
          fi

      - name: Deploy schema to database
        working-directory: next-app
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
        run: |
          if [ -z "$POSTGRES_URL" ]; then
            echo "âŒ Error: POSTGRES_URL secret is not set"
            echo "Please add POSTGRES_URL to repository secrets:"
            echo "  Settings > Secrets and variables > Actions > New repository secret"
            exit 1
          fi
          
          echo "ðŸš€ Deploying schema to database..."
          npm run db:push
          
          echo ""
          echo "âœ… Schema deployed successfully!"

      - name: Verify deployment
        working-directory: next-app
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
        run: |
          echo "ðŸ” Verifying database connection..."
          echo "âœ… Schema deployment completed"
          echo "ðŸ’¡ Verify the deployment by:"
          echo "   1. Checking your database directly"
          echo "   2. Running the application and testing endpoints"
          echo "   3. Using Drizzle Studio: npm run db:studio"

      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸ—„ï¸ Database Schema Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'development' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Status**: Deployment successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Schema Tables" >> $GITHUB_STEP_SUMMARY
          echo "- users" >> $GITHUB_STEP_SUMMARY
          echo "- jobs" >> $GITHUB_STEP_SUMMARY
          echo "- posts" >> $GITHUB_STEP_SUMMARY
          echo "- messages" >> $GITHUB_STEP_SUMMARY
          echo "- notifications" >> $GITHUB_STEP_SUMMARY
          echo "- push_subscriptions" >> $GITHUB_STEP_SUMMARY
          echo "- applications" >> $GITHUB_STEP_SUMMARY
          echo "- reviews" >> $GITHUB_STEP_SUMMARY
