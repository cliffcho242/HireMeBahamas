name: Frontend CI, Security Checks & GitHub Pages Deployment

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # -------------------------------
  # Frontend CI
  # -------------------------------
  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend with TypeScript check
        working-directory: ./frontend
        run: npm run build

  # -------------------------------
  # Security Validation Jobs
  # -------------------------------
  security-validation:
    name: Security Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run security validation script
        id: security_check
        run: |
          python3 scripts/check_security.py
        continue-on-error: true

  environment-secrets:
    name: Environment Secret Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      SECRET_KEY: ${{ secrets.SECRET_KEY || 'test-secret-key-ci' }}
      JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY || 'test-jwt-secret-ci' }}

    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Validate secrets
        run: |
          python3 << 'EOF'
          import os, sys
          secret_key = os.getenv("SECRET_KEY")
          jwt_secret = os.getenv("JWT_SECRET_KEY")
          errors = []
          if not secret_key or len(secret_key)<32: errors.append("SECRET_KEY missing/short")
          if not jwt_secret or len(jwt_secret)<32: errors.append("JWT_SECRET_KEY missing/short")
          if secret_key == jwt_secret: errors.append("SECRET_KEY and JWT_SECRET_KEY must differ")
          if errors: print("❌ Secret validation failed:", errors); sys.exit(1)
          else: print("✅ Secrets validated")
          EOF

  database-ssl-validation:
    name: Database SSL Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
      - name: Check SSL enforcement
        run: |
          files=("backend/app/database.py" "api/database.py")
          for f in "${files[@]}"; do
            if [ -f "$f" ]; then
              if grep -q "sslmode=require\|ensure_sslmode" "$f"; then echo "✅ $f: SSL enforced"; else echo "⚠️  $f: SSL NOT enforced"; fi
            fi
          done

  security-headers-validation:
    name: Security Headers Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
      - name: Validate headers
        run: |
          headers=( "X-Content-Type-Options" "X-Frame-Options" "Strict-Transport-Security" "Referrer-Policy" "Permissions-Policy" )
          missing=()
          for h in "${headers[@]}"; do
            if ! grep -q "$h" vercel.json 2>/dev/null; then missing+=("$h"); else echo "✅ $h present"; fi
          done
          if [ ${#missing[@]} -ne 0 ]; then echo "::error::Missing headers: ${missing[*]}"; exit 1; fi

  rate-limiting-check:
    name: Rate Limiting Check
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
      - name: Check rate limiting in auth.py
        run: |
          if [ -f "backend/app/api/auth.py" ]; then
            if grep -q "rate.limit\|check_rate_limit\|MAX_LOGIN_ATTEMPTS" backend/app/api/auth.py; then
              echo "✅ Rate limiting present"
            else
              echo "⚠️  Rate limiting missing"
            fi
          fi

  documentation-check:
    name: Documentation Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
      - name: Validate security docs
        run: |
          ok=true
          for f in SECURITY.md SECURITY_CHECKLIST.md; do
            if [ ! -f "$f" ]; then echo "❌ $f missing"; ok=false; else echo "✅ $f exists"; fi
          done
          if [ "$ok" = false ]; then exit 1; fi

  # -------------------------------
  # GitHub Pages Deployment
  # -------------------------------
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: frontend-ci
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: node-version: '20'

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './frontend/dist'
          if-no-files-found: error

      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4

  # -------------------------------
  # Workflow Summary
  # -------------------------------
  summary:
    name: CI & Security Summary
    runs-on: ubuntu-latest
    needs: [frontend-ci, security-validation, environment-secrets, database-ssl-validation, security-headers-validation, rate-limiting-check, documentation-check, deploy-pages]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Generate summary
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for job in frontend-ci security-validation environment-secrets database-ssl-validation security-headers-validation rate-limiting-check documentation-check deploy-pages; do
            echo "- $job: ${{ needs[job].result }}" >> $GITHUB_STEP_SUMMARY
          done
          echo ""
          echo "Deployed site URL: ${{ needs.deploy-pages.outputs.page_url || 'Not deployed' }}" >> $GITHUB_STEP_SUMMARY
