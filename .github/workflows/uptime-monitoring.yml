name: Uptime Monitoring

on:
  schedule:
    - cron: '*/15 * * * *'  # Run every 15 minutes
  workflow_dispatch:
    inputs:
      create_issue_on_failure:
        description: 'Create issue if health check fails'
        required: false
        type: boolean
        default: false

concurrency:
  group: uptime-monitoring
  cancel-in-progress: true

jobs:
  health-check:
    name: Application Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write

    outputs:
      railway_status: ${{ steps.check-railway.outputs.status }}
      overall_status: ${{ steps.summary.outputs.overall_status }}

    steps:
      - name: Install jq (required)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check Railway Backend Health
        id: check-railway
        continue-on-error: true
        env:
          RAILWAY_BACKEND_URL: ${{ vars.RAILWAY_BACKEND_URL }}
        run: |
          if [ -z "$RAILWAY_BACKEND_URL" ]; then
            echo "â„¹ï¸ RAILWAY_BACKEND_URL not configured"
            echo "status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          response=$(curl -s -w "\n%{http_code}" --max-time 30 "$RAILWAY_BACKEND_URL/api/health" || true)
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)

          if [ "$http_code" = "200" ]; then
            echo "âœ… Railway backend healthy"
            echo "$body" | jq . || echo "$body"
            db_status=$(echo "$body" | jq -r '.database.status // "unknown"' 2>/dev/null)
            if [ "$db_status" = "healthy" ]; then
              echo "status=healthy" >> $GITHUB_OUTPUT
            elif [ "$db_status" = "degraded" ]; then
              echo "status=degraded" >> $GITHUB_OUTPUT
            else
              echo "status=partial" >> $GITHUB_OUTPUT
            fi
          elif [ -n "$http_code" ] && [ "$http_code" != "000" ]; then
            echo "status=error" >> $GITHUB_OUTPUT
          else
            echo "status=down" >> $GITHUB_OUTPUT
          fi

      - name: Measure Railway Response Time
        id: railway-latency
        if: steps.check-railway.outputs.status == 'healthy'
        continue-on-error: true
        env:
          RAILWAY_BACKEND_URL: ${{ vars.RAILWAY_BACKEND_URL }}
        run: |
          start=$(date +%s%N)
          curl -s --max-time 10 "$RAILWAY_BACKEND_URL/ping" > /dev/null || true
          end=$(date +%s%N)
          latency=$(( (end - start) / 1000000 ))
          echo "latency_ms=$latency" >> $GITHUB_OUTPUT

      - name: Generate Summary
        id: summary
        run: |
          status="${{ steps.check-railway.outputs.status }}"
          latency="${{ steps.railway-latency.outputs.latency_ms }}"

          echo "## ðŸ“Š Uptime Monitoring Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          case "$status" in
            healthy)
              echo "| Railway Backend | âœ… Healthy | Latency: ${latency:-N/A}ms |" >> $GITHUB_STEP_SUMMARY
              overall="healthy"
              ;;
            degraded)
              echo "| Railway Backend | âš ï¸ Degraded | Database issues detected |" >> $GITHUB_STEP_SUMMARY
              overall="degraded"
              ;;
            partial)
              echo "| Railway Backend | âš ï¸ Partial | Some components may have issues |" >> $GITHUB_STEP_SUMMARY
              overall="partial"
              ;;
            error)
              echo "| Railway Backend | âŒ Error | HTTP error |" >> $GITHUB_STEP_SUMMARY
              overall="error"
              ;;
            down)
              echo "| Railway Backend | âŒ Down | Unreachable |" >> $GITHUB_STEP_SUMMARY
              overall="critical"
              ;;
            skipped)
              echo "| Railway Backend | â­ï¸ Skipped | Not configured |" >> $GITHUB_STEP_SUMMARY
              overall="skipped"
              ;;
            *)
              echo "| Railway Backend | â“ Unknown | Status: $status |" >> $GITHUB_STEP_SUMMARY
              overall="unknown"
              ;;
          esac

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Overall Status: ${overall^^}" >> $GITHUB_STEP_SUMMARY
          echo "overall_status=$overall" >> $GITHUB_OUTPUT

      - name: Create Issue on Critical Failure
        if: steps.check-railway.outputs.status == 'down' && (github.event_name == 'schedule' || github.event.inputs.create_issue_on_failure == 'true')
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.check-railway.outputs.status }}';
            if (status !== 'down') return;
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'alert:downtime'
            });
            if (existing.data.length > 0) { console.log('Issue exists, skipping'); return; }
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Service Downtime Alert`,
              body: `Backend unreachable at ${new Date().toISOString()}`,
              labels: ['alert:downtime','priority:high']
            });
