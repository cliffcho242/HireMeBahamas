name: Render Backend Uptime Monitoring

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:

concurrency:
  group: render-uptime-monitoring
  cancel-in-progress: true

jobs:
  health-check:
    name: Application Health Check (Render)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      # issues permission removed since we no longer create issues

    steps:
      # --------------------------------------------------
      # Install jq for JSON parsing
      # --------------------------------------------------
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # --------------------------------------------------
      # Render backend health check
      # --------------------------------------------------
      - name: Check Render Backend Health
        id: check-render
        continue-on-error: true
        env:
          RENDER_BACKEND_URL: ${{ vars.RENDER_BACKEND_URL }}
        run: |
          if [ -z "$RENDER_BACKEND_URL" ]; then
            echo "â„¹ï¸ RENDER_BACKEND_URL not configured"
            echo "status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ðŸ” Checking Render backend health"
          response=$(curl -s -w "\n%{http_code}" --max-time 30 "$RENDER_BACKEND_URL/health" || true)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)

          if [ "$http_code" = "200" ]; then
            db_status=$(echo "$body" | jq -r '.database.status // "unknown"' 2>/dev/null)
            case "$db_status" in
              healthy)  status="healthy" ;;
              degraded) status="degraded" ;;
              *)         status="partial" ;;
            esac
          elif [ "$http_code" != "000" ]; then
            status="error"
          else
            status="down"
          fi

          echo "status=$status" >> $GITHUB_OUTPUT

      # --------------------------------------------------
      # Measure latency (only if healthy)
      # --------------------------------------------------
      - name: Measure Render Response Time
        if: steps.check-render.outputs.status == 'healthy'
        env:
          RENDER_BACKEND_URL: ${{ vars.RENDER_BACKEND_URL }}
        run: |
          start=$(date +%s%N)
          curl -s --max-time 10 "$RENDER_BACKEND_URL/ping" > /dev/null || true
          end=$(date +%s%N)
          latency=$(( (end - start) / 1000000 ))
          echo "latency_ms=$latency" >> $GITHUB_OUTPUT

      # --------------------------------------------------
      # Generate monitoring summary (no issue creation)
      # --------------------------------------------------
      - name: Generate Summary
        run: |
          status="${{ steps.check-render.outputs.status }}"

          echo "## ðŸ“Š Render Backend Uptime Report" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY

          case "$status" in
            healthy)  echo "| Render Backend | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY ;;
            degraded) echo "| Render Backend | âš ï¸ Degraded |" >> $GITHUB_STEP_SUMMARY ;;
            partial)  echo "| Render Backend | âš ï¸ Partial |" >> $GITHUB_STEP_SUMMARY ;;
            error)    echo "| Render Backend | âŒ Error |" >> $GITHUB_STEP_SUMMARY ;;
            down)     echo "| Render Backend | âŒ Down |" >> $GITHUB_STEP_SUMMARY ;;
            skipped)  echo "| Render Backend | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY ;;
            *)        echo "| Render Backend | â“ Unknown |" >> $GITHUB_STEP_SUMMARY ;;
          esac
