name: Keep Database Awake

# This workflow prevents the PostgreSQL database from sleeping by periodically
# pinging the backend's dedicated database ping endpoint. Railway free/hobby tier
# databases sleep after 15 minutes of inactivity.
#
# Schedule: Every 2 minutes (very aggressive to ensure database never sleeps)
# This acts as a backup to the in-app keepalive mechanism and ensures
# the database stays awake even during deployment windows.
# Using 2 minutes provides maximum reliability against 15-minute sleep threshold.

on:
  schedule:
    # Run every 2 minutes to prevent database sleep
    # Railway databases sleep after 15 minutes of inactivity
    # 2-minute interval provides maximum reliability
    - cron: '*/2 * * * *'
  workflow_dispatch:
    # Allow manual trigger for testing

concurrency:
  group: keep-database-awake
  cancel-in-progress: true

jobs:
  ping-database:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    
    steps:
      - name: Ping Railway Database (Direct Ping Endpoint)
        id: ping-railway-db
        continue-on-error: true
        env:
          RAILWAY_BACKEND_URL: ${{ vars.RAILWAY_BACKEND_URL }}
        run: |
          if [ -z "$RAILWAY_BACKEND_URL" ]; then
            echo "â„¹ï¸ RAILWAY_BACKEND_URL not configured, skipping Railway ping"
            echo "skipped=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ðŸ”„ Pinging Railway database at $RAILWAY_BACKEND_URL/api/database/ping"
          
          # First attempt with 30s timeout - use dedicated database ping endpoint
          response=$(curl -s -w "\n%{http_code}" \
            --max-time 30 \
            -X POST \
            "$RAILWAY_BACKEND_URL/api/database/ping" 2>/dev/null) || true
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Railway database ping successful (HTTP $http_code)"
            echo "$body" | jq . 2>/dev/null || echo "$body"
            echo "success=true" >> $GITHUB_OUTPUT
          elif [ -n "$http_code" ] && [ "$http_code" != "000" ]; then
            echo "âš ï¸ Railway database ping responded with HTTP $http_code"
            echo "$body" | head -20
            echo "success=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Railway backend did not respond (may be waking up)"
            echo "ðŸ”„ Retrying with longer timeout (90s)..."
            
            # Second attempt with 90s timeout (for cold starts)
            response=$(curl -s -w "\n%{http_code}" \
              --max-time 90 \
              -X POST \
              "$RAILWAY_BACKEND_URL/api/database/ping" 2>/dev/null) || true
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | head -n -1)
            
            if [ "$http_code" = "200" ]; then
              echo "âœ… Railway database ping successful after retry (HTTP $http_code)"
              echo "$body" | jq . 2>/dev/null || echo "$body"
              echo "success=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Railway database ping failed after retry"
              echo "success=false" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Ping Railway Health Endpoint (Backup)
        id: ping-railway-health
        continue-on-error: true
        if: steps.ping-railway-db.outputs.success != 'true' && steps.ping-railway-db.outputs.skipped != 'true'
        env:
          RAILWAY_BACKEND_URL: ${{ vars.RAILWAY_BACKEND_URL }}
        run: |
          echo "ðŸ”„ Fallback: Pinging Railway health at $RAILWAY_BACKEND_URL/api/health"
          
          response=$(curl -s -w "\n%{http_code}" \
            --max-time 60 \
            "$RAILWAY_BACKEND_URL/api/health" 2>/dev/null) || true
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Railway health check successful (HTTP $http_code)"
            echo "$body" | head -20
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Railway health check failed (HTTP $http_code)"
            echo "success=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Ping Render Database (Direct Ping Endpoint)
        id: ping-render-db
        continue-on-error: true
        env:
          RENDER_BACKEND_URL: ${{ vars.RENDER_BACKEND_URL }}
        run: |
          if [ -z "$RENDER_BACKEND_URL" ]; then
            echo "â„¹ï¸ RENDER_BACKEND_URL not configured, skipping Render ping"
            echo "skipped=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ðŸ”„ Pinging Render database at $RENDER_BACKEND_URL/api/database/ping"
          
          # First attempt with 30s timeout - use dedicated database ping endpoint
          response=$(curl -s -w "\n%{http_code}" \
            --max-time 30 \
            -X POST \
            "$RENDER_BACKEND_URL/api/database/ping" 2>/dev/null) || true
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Render database ping successful (HTTP $http_code)"
            echo "$body" | jq . 2>/dev/null || echo "$body"
            echo "success=true" >> $GITHUB_OUTPUT
          elif [ -n "$http_code" ] && [ "$http_code" != "000" ]; then
            echo "âš ï¸ Render database ping responded with HTTP $http_code"
            echo "$body" | head -20
            echo "success=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Render backend did not respond (may be waking up)"
            echo "ðŸ”„ Retrying with longer timeout (90s)..."
            
            # Second attempt with 90s timeout (for cold starts)
            response=$(curl -s -w "\n%{http_code}" \
              --max-time 90 \
              -X POST \
              "$RENDER_BACKEND_URL/api/database/ping" 2>/dev/null) || true
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | head -n -1)
            
            if [ "$http_code" = "200" ]; then
              echo "âœ… Render database ping successful after retry (HTTP $http_code)"
              echo "$body" | jq . 2>/dev/null || echo "$body"
              echo "success=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Render database ping failed after retry"
              echo "success=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Summary
        run: |
          echo "## Database Keepalive Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Database Ping | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          railway_db_status="${{ steps.ping-railway-db.outputs.success }}"
          railway_health_status="${{ steps.ping-railway-health.outputs.success }}"
          railway_skipped="${{ steps.ping-railway-db.outputs.skipped }}"
          
          if [ "$railway_skipped" = "true" ]; then
            echo "| Railway | â­ï¸ Skipped | Not configured |" >> $GITHUB_STEP_SUMMARY
          elif [ "$railway_db_status" = "true" ]; then
            echo "| Railway | âœ… Success | Database awake |" >> $GITHUB_STEP_SUMMARY
          elif [ "$railway_health_status" = "true" ]; then
            echo "| Railway | âš ï¸ Fallback | Health OK, DB ping failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Railway | âŒ Failed | Both endpoints failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          render_db_status="${{ steps.ping-render-db.outputs.success }}"
          render_skipped="${{ steps.ping-render-db.outputs.skipped }}"
          
          if [ "$render_skipped" = "true" ]; then
            echo "| Render | â­ï¸ Skipped | Not configured |" >> $GITHUB_STEP_SUMMARY
          elif [ "$render_db_status" = "true" ]; then
            echo "| Render | âœ… Success | Database awake |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Render | âŒ Failed | Database ping failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow runs **every 2 minutes** to prevent the Railway PostgreSQL database from sleeping." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Endpoints Used" >> $GITHUB_STEP_SUMMARY
          echo "- Primary: \`/api/database/ping\` - Direct database ping with keepalive thread health check" >> $GITHUB_STEP_SUMMARY
          echo "- Fallback: \`/api/health\` - General health check" >> $GITHUB_STEP_SUMMARY
