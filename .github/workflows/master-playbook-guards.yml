name: Master Playbook - Security Guards

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  master-playbook-guards:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸ›¡ï¸ Check for forbidden sslmode in connect_args
        run: |
          echo "ğŸ” Checking for forbidden 'sslmode' in connect_args..."
          
          # Check for sslmode in connect_args (forbidden for asyncpg)
          # Exclude comment lines that start with # (after optional whitespace)
          if grep -E "connect_args.*['\"]sslmode['\"]" --include="*.py" backend/app/*.py 2>/dev/null | grep -v "^[[:space:]]*#"; then
            echo "::error::âŒ FORBIDDEN: 'sslmode' key in connect_args dictionary"
            echo "Master Playbook violation: sslmode in connect_args causes asyncpg errors"
            echo "Use SSL configuration via connect_args['ssl'] instead"
            exit 1
          fi
          
          echo "âœ… No sslmode in connect_args violations found"

      - name: ğŸ›¡ï¸ Check for forbidden statement_timeout at startup
        run: |
          echo "ğŸ” Checking for forbidden 'statement_timeout' at startup..."
          
          # Check for statement_timeout in connect_args or server_settings
          # Exclude comments (lines starting with # after optional whitespace)
          if grep -E "connect_args.*statement_timeout|server_settings.*statement_timeout" --include="*.py" backend/app/database.py 2>/dev/null | grep -v "^[[:space:]]*#"; then
            echo "::error::âŒ FORBIDDEN: 'statement_timeout' found at startup in database.py"
            echo "Master Playbook violation: statement_timeout at startup is forbidden (not compatible with Neon pooler)"
            exit 1
          fi
          
          echo "âœ… No statement_timeout at startup violations found"

      - name: ğŸ›¡ï¸ Check health endpoint doesn't touch DB
        run: |
          echo "ğŸ” Checking /health endpoint doesn't access database..."
          
          # Look for database calls in health endpoint
          if grep -A 20 '@app.get("/health"' backend/app/main.py | grep -E "(get_db|session|query|execute|select)"; then
            echo "::error::âŒ FORBIDDEN: /health endpoint touches database"
            echo "Master Playbook violation: /health must be instant, no DB access"
            exit 1
          fi
          
          echo "âœ… Health endpoint is database-free"

      - name: ğŸ›¡ï¸ Check for Base.metadata.create_all in production
        run: |
          echo "ğŸ” Checking for Base.metadata.create_all()..."
          
          # Check for create_all in non-test files
          if grep -r "Base.metadata.create_all" --include="*.py" backend/app/ 2>/dev/null | grep -v "test_" | grep -v "# "; then
            echo "::error::âŒ FORBIDDEN: Base.metadata.create_all() found in production code"
            echo "Master Playbook violation: Use Alembic migrations, never create_all in prod"
            exit 1
          fi
          
          echo "âœ… No create_all violations found"

      - name: ğŸ›¡ï¸ Check Gunicorn worker count
        run: |
          echo "ğŸ” Checking Gunicorn worker configuration..."
          
          # Check render.yaml for WEB_CONCURRENCY
          if [ -f "render.yaml" ]; then
            if grep -A 1 "WEB_CONCURRENCY" render.yaml | grep -E 'value:.*"[2-9]"'; then
              echo "::error::âŒ FORBIDDEN: More than 1 worker in render.yaml WEB_CONCURRENCY"
              echo "Master Playbook violation: Must use exactly 1 worker"
              exit 1
            fi
            echo "âœ… render.yaml: WEB_CONCURRENCY correctly set to 1"
          fi
          
          # Check gunicorn.conf.py default worker value
          if [ -f "backend/gunicorn.conf.py" ]; then
            if grep -E 'workers.*=.*get\(.*"[2-9]"\)' backend/gunicorn.conf.py; then
              echo "::error::âŒ FORBIDDEN: Default workers > 1 in gunicorn.conf.py"
              echo "Master Playbook violation: Default must be 1 worker"
              exit 1
            fi
            echo "âœ… gunicorn.conf.py: Default workers is 1"
          fi
          
          # Check Procfile for explicit --workers flag
          if [ -f "Procfile" ]; then
            if grep "gunicorn" Procfile | grep -E "\-\-workers[= ][2-9]"; then
              echo "::error::âŒ FORBIDDEN: Explicit --workers > 1 in Procfile"
              echo "Master Playbook violation: Must use exactly 1 worker"
              exit 1
            fi
            echo "âœ… Procfile: No explicit multi-worker configuration"
          fi
          
          echo "âœ… Gunicorn configured with 1 worker (correct)"

      - name: ğŸ›¡ï¸ Check frontend uses VITE_ not NEXT_PUBLIC_
        run: |
          echo "ğŸ” Checking frontend environment variable naming..."
          
          # Check for NEXT_PUBLIC_ in frontend code (wrong framework)
          if grep -r "NEXT_PUBLIC_" --include="*.ts" --include="*.tsx" frontend/src/ 2>/dev/null | grep -v "// " | grep -v "Wrong"; then
            echo "::warning::âš ï¸ Found NEXT_PUBLIC_ prefix in frontend code"
            echo "This project uses Vite, not Next.js. Use VITE_ prefix instead."
            echo "Note: This is a warning, not blocking the build."
          fi
          
          echo "âœ… Frontend environment variable check complete"

      - name: ğŸ›¡ï¸ Check for hardcoded ports
        run: |
          echo "ğŸ” Checking for hardcoded ports..."
          
          # Check for hardcoded port 5432 (PostgreSQL) in HTTP bind config
          if grep -r "bind.*5432" --include="*.py" backend/ 2>/dev/null; then
            echo "::error::âŒ FORBIDDEN: Hardcoded port 5432 in HTTP configuration"
            echo "Master Playbook violation: Port 5432 is for PostgreSQL, not HTTP"
            exit 1
          fi
          
          echo "âœ… No hardcoded port violations found"

      - name: ğŸ“Š Summary
        if: success()
        run: |
          echo ""
          echo "âœ… All Master Playbook security guards PASSED"
          echo ""
          echo "Verified:"
          echo "  âœ“ No sslmode in code"
          echo "  âœ“ No statement_timeout at startup"
          echo "  âœ“ /health endpoint is DB-free"
          echo "  âœ“ No Base.metadata.create_all() in prod"
          echo "  âœ“ Gunicorn uses 1 worker only"
          echo "  âœ“ No hardcoded ports"
          echo ""
          echo "ğŸ‰ Code is Master Playbook compliant!"
