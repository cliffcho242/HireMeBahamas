name: Uptime Monitoring (Render Backend)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:
    inputs:
      create_issue_on_failure:
        description: "Create GitHub issue if backend is down"
        required: false
        type: boolean
        default: false

concurrency:
  group: uptime-monitoring
  cancel-in-progress: true

jobs:
  health-check:
    name: Render Backend Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      issues: write

    steps:
      - name: Validate Render backend URL exists
        run: |
          if [ -z "${{ vars.RENDER_BACKEND_URL }}" ]; then
            echo "‚ùå RENDER_BACKEND_URL repository variable is missing"
            exit 1
          fi

      - name: Check Render backend health
        id: backend
        continue-on-error: true
        env:
          BACKEND_URL: ${{ vars.RENDER_BACKEND_URL }}
        run: |
          echo "üîç Checking Render backend: $BACKEND_URL"

          response=$(curl -s -m 30 -w "\n%{http_code}" "$BACKEND_URL/health" || true)
          http_code=$(echo "$response" | tail -n1)

          echo "HTTP code: $http_code"

          if [ "$http_code" = "200" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
          elif [ "$http_code" != "000" ]; then
            echo "status=error" >> $GITHUB_OUTPUT
          else
            echo "status=down" >> $GITHUB_OUTPUT
          fi

      - name: Measure backend latency
        if: steps.backend.outputs.status == 'healthy'
        env:
          BACKEND_URL: ${{ vars.RENDER_BACKEND_URL }}
        run: |
          start=$(date +%s%N)
          curl -s "$BACKEND_URL/health" >/dev/null || true
          end=$(date +%s%N)
          latency=$(( (end - start) / 1000000 ))
          echo "‚è± Latency: ${latency}ms"

      - name: Generate summary
        run: |
          echo "## üìä HireMeBahamas Uptime Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time (UTC):** $(date -u '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Render Backend | ${{ steps.backend.outputs.status }} |" >> $GITHUB_STEP_SUMMARY

      - name: Create GitHub issue on downtime
        if: |
          steps.backend.outputs.status == 'down' &&
          (github.event_name == 'schedule' ||
           github.event.inputs.create_issue_on_failure == 'true')
        uses: actions/github-script@v7
        env:
          BACKEND_URL: ${{ vars.RENDER_BACKEND_URL }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const existing = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              labels: "alert:downtime"
            });

            if (existing.data.length > 0) {
              console.log("‚ö†Ô∏è Downtime issue already exists");
              return;
            }

            await github.rest.issues.create({
              owner,
              repo,
              title: "üö® HireMeBahamas Backend Down (Render)",
              body: [
                "## Backend service is unreachable",
                "",
                `**Time:** ${new Date().toISOString()}`,
                `**Endpoint:** ${process.env.BACKEND_URL}/health`,
                "",
                "### Recommended Actions",
                "- Check Render logs",
                "- Verify database connectivity",
                "- Review latest deployment"
              ].join("\n"),
              labels: ["alert:downtime", "priority:high"]
            });
