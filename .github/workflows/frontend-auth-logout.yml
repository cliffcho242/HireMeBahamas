name: Uptime Monitoring

on:
  schedule:
    - cron: '*/15 * * * *'   # every 15 minutes
  workflow_dispatch:
    inputs:
      create_issue_on_failure:
        description: 'Create GitHub issue if service is down'
        required: false
        default: 'false'

concurrency:
  group: uptime-monitoring
  cancel-in-progress: true

jobs:
  health-check:
    name: Application Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      issues: write

    steps:
      - name: Validate backend URL exists
        run: |
          if [ -z "${{ vars.RAILWAY_BACKEND_URL }}" ]; then
            echo "âŒ RAILWAY_BACKEND_URL repository variable is missing"
            exit 1
          fi

      - name: Check backend health endpoint
        id: backend
        continue-on-error: true
        env:
          BACKEND_URL: ${{ vars.RAILWAY_BACKEND_URL }}
        run: |
          echo "Checking backend: $BACKEND_URL"

          response=$(curl -s -m 30 -w "\n%{http_code}" "$BACKEND_URL/api/health" || true)
          code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)

          echo "HTTP_CODE=$code" >> $GITHUB_ENV
          echo "BODY=$body" >> $GITHUB_ENV

          if [ "$code" = "200" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
          elif [ -n "$code" ]; then
            echo "status=error" >> $GITHUB_OUTPUT
          else
            echo "status=down" >> $GITHUB_OUTPUT
          fi

      - name: Measure backend latency
        if: steps.backend.outputs.status == 'healthy'
        run: |
          start=$(date +%s%N)
          curl -s "$BACKEND_URL/ping" >/dev/null || true
          end=$(date +%s%N)
          latency=$(( (end - start) / 1000000 ))
          echo "Latency: ${latency}ms"

      - name: Generate summary
        run: |
          echo "## ðŸ“Š HireMeBahamas Uptime Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.backend.outputs.status }} |" >> $GITHUB_STEP_SUMMARY

      - name: Create issue on downtime
        if: |
          steps.backend.outputs.status == 'down' &&
          (github.event_name == 'schedule' ||
           github.event.inputs.create_issue_on_failure == 'true')
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'alert:downtime'
            });

            if (issues.data.length > 0) {
              console.log('Existing downtime issue found');
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ HireMeBahamas Backend Down',
              body: `
              ## Backend service is unreachable

              **Time:** ${new Date().toISOString()}
              **Endpoint:** ${{ vars.RAILWAY_BACKEND_URL }}/api/health

              ### Actions
              - Check Railway logs
              - Verify database connectivity
              - Review latest deployments
              `,
              labels: ['alert:downtime', 'priority:high']
            });
