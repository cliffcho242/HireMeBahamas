name: Uptime Monitoring (Render Backend)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: uptime-monitoring
  cancel-in-progress: true

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      issues: write

    steps:
      - name: Validate Render backend URL exists
        run: |
          if [ -z "${RENDER_BACKEND_URL}" ]; then
            echo "RENDER_BACKEND_URL repository variable is missing"
            exit 1
          fi
        env:
          RENDER_BACKEND_URL: ${{ vars.RENDER_BACKEND_URL }}

      - name: Check Render backend health
        id: backend
        continue-on-error: true
        run: |
          echo "Checking backend at $RENDER_BACKEND_URL"

          RESPONSE=$(curl -s -m 30 -w "\n%{http_code}" "$RENDER_BACKEND_URL/health" || true)
          CODE=$(echo "$RESPONSE" | tail -n1)

          if [ "$CODE" = "200" ]; then
            echo "status=healthy" >> "$GITHUB_OUTPUT"
          elif [ "$CODE" = "000" ]; then
            echo "status=down" >> "$GITHUB_OUTPUT"
          else
            echo "status=error" >> "$GITHUB_OUTPUT"
          fi
        env:
          RENDER_BACKEND_URL: ${{ vars.RENDER_BACKEND_URL }}

      - name: Generate summary
        run: |
          echo "## ðŸ“Š HireMeBahamas Uptime Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Time (UTC):** $(date -u '+%Y-%m-%d %H:%M:%S')" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Service | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Render Backend | ${{ steps.backend.outputs.status }} |" >> "$GITHUB_STEP_SUMMARY"

      - name: Create GitHub issue on downtime
        if: steps.backend.outputs.status == 'down'
        uses: actions/github-script@v7
        env:
          BACKEND_URL: ${{ vars.RENDER_BACKEND_URL }}
        with:
          script: |
            const { owner, repo } = context.repo;

            const existing = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'alert:downtime'
            });

            if (existing.data.length > 0) {
              console.log('Downtime issue already exists');
              return;
            }

            await github.rest.issues.create({
              owner,
              repo,
              title: 'ðŸš¨ HireMeBahamas Backend Down (Render)',
              body: [
                '## Backend service is unreachable',
                '',
                `Time: ${new Date().toISOString()}`,
                `Endpoint: ${process.env.BACKEND_URL}/health`,
                '',
                '### Recommended Actions',
                '- Check Render logs',
                '- Verify database connectivity',
                '- Review latest deployment'
              ].join('\n'),
              labels: ['alert:downtime', 'priority:high']
            });
