name: Deploy Frontend to Vercel

'on':
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL || 
            'https://hiremebahamas.onrender.com' }}

      - name: Check Vercel secrets
        id: check_secrets
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          if [ -n "$VERCEL_TOKEN" ] && [ -n "$VERCEL_ORG_ID" ] && [ -n "$VERCEL_PROJECT_ID" ]; then
            echo "secrets_configured=true" >> $GITHUB_OUTPUT
          else
            echo "secrets_configured=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Vercel secrets not configured. Skipping Vercel deployment via GitHub Actions."
            echo "The frontend will be deployed automatically via Vercel's native Git integration."
            echo ""
            echo "To enable deployment via GitHub Actions, configure these secrets:"
            echo "  - VERCEL_TOKEN: Generate at https://vercel.com/account/tokens"
            echo "  - VERCEL_ORG_ID: Found in Vercel project settings"
            echo "  - VERCEL_PROJECT_ID: Found in Vercel project settings"
          fi

      - name: Deploy to Vercel
        if: steps.check_secrets.outputs.secrets_configured == 'true'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend
          vercel-args: '--prod'

      - name: Deployment status
        if: steps.check_secrets.outputs.secrets_configured != 'true'
        run: |
          echo "‚úÖ Build completed successfully!"
          echo "üì¶ Frontend assets are ready for deployment via Vercel's Git integration."
