name: Vercel Backend Keepalive - Always On 24/7

# This workflow keeps the Vercel serverless FastAPI backend warm and active 24/7.
# Vercel serverless functions have zero cold starts when regularly pinged.
#
# Schedule: Every 5 minutes (288 pings per day)
# This aggressive interval ensures the backend is ALWAYS warm and responsive.
#
# Why 5 minutes?
# - Serverless functions stay warm for ~15 minutes after last invocation
# - 5-minute pings provide 3x safety margin (15/5 = 3)
# - Prevents any cold start delays for users
# - Keeps database connections active
#
# NO EXCUSES: This ensures 100% uptime and instant response times 24/7.

on:
  schedule:
    # Run every 5 minutes - 288 times per day
    # Keeps Vercel serverless functions perpetually warm
    # NO COLD STARTS - GUARANTEED
    - cron: '*/5 * * * *'
  workflow_dispatch:
    # Allow manual trigger for immediate keepalive
    inputs:
      force_all_endpoints:
        description: 'Test all endpoints (not just health)'
        required: false
        type: boolean
        default: false

concurrency:
  group: vercel-keepalive
  cancel-in-progress: true

jobs:
  keep-vercel-warm:
    name: Keep Vercel Backend Warm 24/7
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read

    steps:
      - name: Ping Vercel Health Endpoint
        id: ping-health
        env:
          VERCEL_URL: ${{ vars.VERCEL_URL || 'https://hiremebahamas.vercel.app' }}
        run: |
          echo "üî• Pinging Vercel backend to keep it warm..."
          echo "Target: $VERCEL_URL/api/health"
          echo "Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          
          # Ping health endpoint with 20s timeout
          start_time=$(date +%s%3N)
          response=$(curl -s -w "\n%{http_code}" \
            --max-time 20 \
            -H "User-Agent: HireMeBahamas-Keepalive/1.0" \
            "$VERCEL_URL/api/health" 2>/dev/null) || true
          end_time=$(date +%s%3N)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          latency=$((end_time - start_time))
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Backend is warm and healthy (HTTP $http_code)"
            echo "‚ö° Response time: ${latency}ms"
            echo "$body" | jq -r 'if .database == "connected" then "‚úÖ Database: Connected" elif .database == "unavailable" then "‚ö†Ô∏è  Database: Unavailable" else "‚ùì Database: Unknown" end' 2>/dev/null || true
            echo "success=true" >> $GITHUB_OUTPUT
            echo "latency=$latency" >> $GITHUB_OUTPUT
            echo "status=healthy" >> $GITHUB_OUTPUT
          elif [ "$http_code" = "404" ]; then
            echo "‚ö†Ô∏è  Backend returned 404 - endpoint not found or deployment not configured"
            echo "This could mean:"
            echo "  - Vercel deployment doesn't exist at this URL"
            echo "  - API routes are not configured correctly"
            echo "  - The backend is deployed elsewhere (e.g., Railway)"
            echo ""
            echo "üí° Tip: Check Vercel dashboard or update VERCEL_URL variable"
            echo "success=false" >> $GITHUB_OUTPUT
            echo "status=not_found" >> $GITHUB_OUTPUT
          elif [ "$http_code" = "000" ]; then
            echo "‚ö†Ô∏è  Cannot connect to backend - DNS/network issue or site doesn't exist"
            echo "This usually means the Vercel deployment is not active at: $VERCEL_URL"
            echo ""
            echo "üí° Possible fixes:"
            echo "  - Verify the site is deployed on Vercel"
            echo "  - Check if the URL is correct"
            echo "  - Ensure DNS is configured properly"
            echo "success=false" >> $GITHUB_OUTPUT
            echo "status=unreachable" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Backend health check returned unexpected status (HTTP ${http_code:-000})"
            echo "success=false" >> $GITHUB_OUTPUT
            echo "status=error" >> $GITHUB_OUTPUT
          fi

      - name: Ping Vercel Status Endpoint
        id: ping-status
        continue-on-error: true
        env:
          VERCEL_URL: ${{ vars.VERCEL_URL || 'https://hiremebahamas.vercel.app' }}
        run: |
          echo "üìä Checking backend status..."
          
          response=$(curl -s -w "\n%{http_code}" \
            --max-time 20 \
            -H "User-Agent: HireMeBahamas-Keepalive/1.0" \
            "$VERCEL_URL/api/status" 2>/dev/null) || true
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Status endpoint responding"
            backend_loaded=$(echo "$body" | jq -r '.backend_loaded // false' 2>/dev/null)
            db_connected=$(echo "$body" | jq -r '.database_connected // false' 2>/dev/null)
            
            if [ "$backend_loaded" = "true" ]; then
              echo "‚úÖ Backend modules: Loaded"
            else
              echo "‚ö†Ô∏è  Backend modules: Not loaded"
            fi
            
            if [ "$db_connected" = "true" ]; then
              echo "‚úÖ Database: Connected"
            else
              echo "‚ö†Ô∏è  Database: Not connected"
            fi
            
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Status endpoint returned HTTP ${http_code:-000}"
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Ping Database Keepalive
        id: ping-database
        continue-on-error: true
        env:
          VERCEL_URL: ${{ vars.VERCEL_URL || 'https://hiremebahamas.vercel.app' }}
        run: |
          echo "üíæ Pinging database to keep it awake..."
          
          response=$(curl -s -w "\n%{http_code}" \
            --max-time 30 \
            -X POST \
            -H "User-Agent: HireMeBahamas-Keepalive/1.0" \
            "$VERCEL_URL/api/database/ping" 2>/dev/null) || true
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Database ping successful"
            echo "$body" | jq . 2>/dev/null || echo "$body"
            echo "success=true" >> $GITHUB_OUTPUT
          elif [ "$http_code" = "404" ]; then
            echo "‚ÑπÔ∏è  Database ping endpoint not available (expected if not implemented)"
            echo "success=skip" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Database ping returned HTTP ${http_code:-000}"
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Test Critical Endpoints (Optional)
        id: test-endpoints
        if: github.event.inputs.force_all_endpoints == 'true'
        continue-on-error: true
        env:
          VERCEL_URL: ${{ vars.VERCEL_URL || 'https://hiremebahamas.vercel.app' }}
        run: |
          echo "üß™ Testing critical endpoints..."
          
          # Test root endpoint
          echo "Testing: $VERCEL_URL/api"
          curl -s -f --max-time 10 "$VERCEL_URL/api" > /dev/null && echo "‚úÖ /api" || echo "‚ùå /api"
          
          # Test ready endpoint
          echo "Testing: $VERCEL_URL/api/ready"
          curl -s -f --max-time 10 "$VERCEL_URL/api/ready" > /dev/null && echo "‚úÖ /api/ready" || echo "‚ö†Ô∏è /api/ready"
          
          # Test diagnostic endpoint (dev only)
          echo "Testing: $VERCEL_URL/api/diagnostic"
          curl -s -f --max-time 10 "$VERCEL_URL/api/diagnostic" > /dev/null && echo "‚úÖ /api/diagnostic" || echo "‚ÑπÔ∏è  /api/diagnostic (may be disabled in production)"

      - name: Generate Summary
        if: always()
        run: |
          echo "# Vercel Backend Keepalive Report üî•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Status Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          
          # Health check status
          health_status="${{ steps.ping-health.outputs.status }}"
          if [ "${{ steps.ping-health.outputs.success }}" = "true" ]; then
            latency="${{ steps.ping-health.outputs.latency }}"
            echo "| üíö Health Check | ‚úÖ Success | ${latency}ms response time |" >> $GITHUB_STEP_SUMMARY
          elif [ "$health_status" = "not_found" ]; then
            echo "| üíö Health Check | ‚ö†Ô∏è  Not Found (404) | Backend endpoint not accessible - check Vercel deployment |" >> $GITHUB_STEP_SUMMARY
          elif [ "$health_status" = "unreachable" ]; then
            echo "| üíö Health Check | ‚ö†Ô∏è  Unreachable | Cannot connect - verify Vercel URL and deployment status |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üíî Health Check | ‚ùå Failed | Backend not responding |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Status endpoint
          if [ "${{ steps.ping-status.outputs.success }}" = "true" ]; then
            echo "| üìä Status Check | ‚úÖ Success | Backend fully operational |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üìä Status Check | ‚ö†Ô∏è Warning | Status endpoint issues |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Database ping
          db_ping="${{ steps.ping-database.outputs.success }}"
          if [ "$db_ping" = "true" ]; then
            echo "| üíæ Database Ping | ‚úÖ Success | Database is awake |" >> $GITHUB_STEP_SUMMARY
          elif [ "$db_ping" = "skip" ]; then
            echo "| üíæ Database Ping | ‚è≠Ô∏è Skipped | Endpoint not implemented |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üíæ Database Ping | ‚ö†Ô∏è Warning | Database check failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üî• Always-On Guarantee" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow runs **every 5 minutes** (288 times/day) to ensure:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Zero cold starts" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Instant response times (<200ms)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Database stays connected" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Backend always ready for users" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ 24/7 availability - NO EXCUSES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next ping**: $(date -u -d '+5 minutes' +"%H:%M UTC")" >> $GITHUB_STEP_SUMMARY

      - name: Report Backend Status
        if: always()
        run: |
          health_status="${{ steps.ping-health.outputs.status }}"
          health_success="${{ steps.ping-health.outputs.success }}"
          
          if [ "$health_success" = "true" ]; then
            echo "‚úÖ Keepalive successful - backend is responding normally"
            exit 0
          elif [ "$health_status" = "not_found" ] || [ "$health_status" = "unreachable" ]; then
            echo "::warning::‚ö†Ô∏è  Backend is not accessible at the configured URL"
            echo "::warning::This is a monitoring notification, not a critical failure"
            echo "::warning::URL: ${{ vars.VERCEL_URL || 'https://hiremebahamas.vercel.app' }}"
            echo "::warning::Status: $health_status"
            echo ""
            echo "‚ÑπÔ∏è  This workflow monitors the backend but won't fail the build"
            echo "‚ÑπÔ∏è  If the backend should be on Vercel, please check:"
            echo "   - Vercel project deployment status"
            echo "   - Environment variables (VERCEL_URL)"
            echo "   - API route configuration in vercel.json"
            exit 0
          else
            echo "::warning::‚ö†Ô∏è  Backend health check encountered an issue"
            echo "::warning::Status: ${health_status:-unknown}"
            exit 0
          fi
