# Railway Configuration for HireMeBahamas Backend
# This file configures the Python backend service ONLY
# 
# ⚠️ CRITICAL: PostgreSQL Configuration
# ====================================
# DO NOT deploy PostgreSQL as a container service!
# Railway will throw: "root execution of the PostgreSQL server is not permitted"
# 
# ✅ CORRECT Setup:
#    1. In Railway Dashboard → + New → Database → PostgreSQL
#    2. Use Railway's managed PostgreSQL database service
#    3. Railway auto-injects DATABASE_URL environment variable
# 
# ❌ WRONG Setup:
#    - Adding PostgreSQL from container image
#    - Deploying docker-compose.yml files
#    - Installing postgresql server packages
# 
# For detailed instructions, see: RAILWAY_POSTGRES_ROOT_ERROR_FIX.md

[build]
builder = "NIXPACKS"
watchPatterns = [
    "api/**/*.py",
    "backend/**/*.py", 
    "*.py",
    "requirements.txt",
    "nixpacks.toml"
]

[deploy]
# STEP 18 - PRODUCTION COMMANDS (FINAL)
# Poetry-managed Gunicorn with configuration file
# - Poetry: Consistent dependency management across environments
# - Gunicorn with 4 workers using UvicornWorker (async event loop)
# - Capacity: 4 workers × ~100+ async connections = 400+ concurrent connections
# - Configuration: All settings centralized in gunicorn.conf.py
# 
# PYTHONPATH is set to current directory (.) after cd to backend, which achieves
# the same effect as PYTHONPATH=backend when run from project root.
# This aligns with problem statement Option B: Set PYTHONPATH=backend
startCommand = "cd backend && PYTHONPATH=. poetry run gunicorn app.main:app --config gunicorn.conf.py"
healthcheckPath = "/health"
healthcheckTimeout = 180
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10
numReplicas = 1

# Prevent Railway from trying to deploy PostgreSQL
# Only the Python backend should be deployed from this repository
[service]
type = "web"
# Explicitly set service type to prevent PostgreSQL container deployment
