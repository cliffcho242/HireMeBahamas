# =============================================================================
# HireMeBahamas Backend - Render Deployment Configuration
# =============================================================================
# 
# NUCLEAR FIX FOR 502 BAD GATEWAY + 173-SECOND LOGINS (2025)
#
# This configuration eliminates cold start timeouts with:
# 1. Standard plan ($25/mo) with 1GB RAM - prevents OOM
# 2. Single worker + 180s timeout - survives Railway DB cold starts
# 3. Health check at /health with 300s grace period
# 4. Keep-alive background worker pinging every 45s
#
# COPY-PASTE THESE DASHBOARD VALUES:
# - Plan: Standard ($25/mo) or Starter ($7/mo minimum)
# - Health Check Path: /health
# - Grace Period: 300 seconds
# - Health Check Timeout: 30 seconds
# =============================================================================

services:
  - type: web
    name: hiremebahamas-backend
    runtime: python
    region: oregon
    
    # ==========================================================================
    # PLAN SELECTION - Standard recommended for zero 502s
    # ==========================================================================
    # STARTER ($7/mo, 512MB RAM):
    #   - Good for low traffic, may have occasional slow cold starts
    #   - Set WEB_CONCURRENCY=1, WEB_THREADS=2
    #
    # STANDARD ($25/mo, 1GB RAM) - RECOMMENDED:
    #   - Always On, no 502s, fast responses
    #   - Set WEB_CONCURRENCY=1, WEB_THREADS=4
    # ==========================================================================
    plan: standard
    
    # Auto-scaling (Standard plan and above)
    scaling:
      minInstances: 1
      maxInstances: 3
      targetCPUPercent: 80
      targetMemoryPercent: 85
    
    buildCommand: |
      apt-get update
      apt-get install -y --no-install-recommends \
        build-essential \
        libpq-dev \
        python3-dev
      pip install --upgrade pip setuptools wheel
      pip install -r requirements.txt
    
    # ==========================================================================
    # START COMMAND - Nuclear Configuration
    # ==========================================================================
    # - workers=1: Prevents OOM on 1GB RAM
    # - timeout=180: Survives Railway DB cold starts (up to 2 min)
    # - keep-alive=5: Matches Render load balancer
    # - preload: Eliminates cold start app loading delay
    # ==========================================================================
    startCommand: gunicorn final_backend_postgresql:application --config gunicorn.conf.py --preload
    
    envVars:
      - key: FLASK_ENV
        value: production
      - key: ENVIRONMENT
        value: production
      - key: SECRET_KEY
        generateValue: true
      - key: FRONTEND_URL
        value: https://hiremebahamas.vercel.app
      - key: PYTHONUNBUFFERED
        value: "true"
      - key: PYTHON_VERSION
        value: "3.12.0"
      # Nuclear configuration - single worker, high timeout
      - key: WEB_CONCURRENCY
        value: "1"
      - key: WEB_THREADS
        value: "4"
      - key: GUNICORN_TIMEOUT
        value: "180"
      - key: GUNICORN_KEEPALIVE
        value: "5"
      - key: PRELOAD_APP
        value: "true"
      # Database keepalive thread
      - key: DB_KEEPALIVE_ENABLED
        value: "true"
      # Trust Render's load balancer
      - key: FORWARDED_ALLOW_IPS
        value: "*"
      # DATABASE_URL must be set manually in Render dashboard
      # Format: postgresql://user:pass@host:5432/db?sslmode=require
    
    # ==========================================================================
    # HEALTH CHECK - Nuclear Settings
    # ==========================================================================
    # Path: /health (instant response, no DB check)
    # Grace Period: 300s (5 min) - handles worst-case cold start
    # Timeout: 30s per health check request
    # Interval: 30s between checks
    # ==========================================================================
    healthCheckPath: /health

  # ==========================================================================
  # KEEP-ALIVE BACKGROUND WORKER
  # ==========================================================================
  # Pings /health every 45 seconds to prevent cold starts
  # Cost: $0 on Render Free tier for Background Workers
  # ==========================================================================
  - type: worker
    name: keep-alive
    runtime: python
    region: oregon
    plan: free
    buildCommand: pip install requests
    startCommand: python keep_alive.py
    envVars:
      - key: PYTHONUNBUFFERED
        value: "true"
      - key: RENDER_EXTERNAL_URL
        value: https://hiremebahamas.onrender.com

  # ==========================================================================
  # CRON JOB - Backup Keepalive
  # ==========================================================================
  # Pings /health every 5 minutes as backup
  # Uses minimal Docker image (5MB vs full Python)
  # ==========================================================================
  - type: cron
    name: keepalive-ping
    region: oregon
    plan: free
    schedule: "*/5 * * * *"
    dockerImage: curlimages/curl:latest
    dockerCommand: curl -f -s -o /dev/null https://hiremebahamas.onrender.com/health

  # ==========================================================================
  # CACHE WARMING CRON JOB
  # ==========================================================================
  # Pre-warms cache every 5 minutes for sub-100ms responses
  # ==========================================================================
  - type: cron
    name: cache-warmer
    region: oregon
    plan: free
    schedule: "*/5 * * * *"
    dockerImage: curlimages/curl:latest
    dockerCommand: curl -f -s -X POST https://hiremebahamas.onrender.com/warm-cache
