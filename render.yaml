# =============================================================================
# HireMeBahamas Backend - Render Deployment Configuration
# ABSOLUTE REQUIREMENTS (PRODUCTION CONFIG)
# =============================================================================
#
# üö® CRITICAL REQUIREMENT #1 (MOST IMPORTANT):
# ============================================
# In Render Dashboard, your service MUST be:
#   ‚úÖ Type: Web Service
#   ‚úÖ Runtime: Python
#
# ‚ùå NOT:
#   - Background Worker
#   - Private Service
#   - Database
#   - TCP Service
#
# ‚ö†Ô∏è  You CANNOT change service type after creation!
# If wrong type ‚Üí DELETE and create NEW Web Service
# See: RENDER_SERVICE_TYPE_VERIFICATION.md for detailed instructions
# =============================================================================
# 
# ‚ö° SINGLE BACKEND PLATFORM - RENDER ONLY:
# - Frontend: Vercel (CDN, Edge, static & dynamic UI)
# - Backend API: Render (ONLY backend platform, NO Railway, NO others)
# - Database: Neon PostgreSQL (managed, scalable)
# 
# ABSOLUTE PROHIBITIONS:
# ‚ùå Multiple Gunicorn workers (MUST be 1)
# ‚ùå DB calls at import time
# ‚ùå psycopg.connect(... sslmode=...) with URL
# ‚ùå Health endpoint touching DB
# ‚ùå Backend on more than one platform
# ‚ùå Railway + Render together
#
# Configuration:
# - Standard plan ($25/mo) with 1GB RAM for Always On
# - FastAPI with Gunicorn (SINGLE worker only)
# - Neon PostgreSQL with connection pooling
# - Health check at /health (NO database access)
# =============================================================================

services:
  # ============================================================================
  # SERVICE TYPE: WEB SERVICE (CRITICAL - DO NOT CHANGE)
  # ============================================================================
  # This MUST be "web" for the backend API to work correctly.
  # If you see any other type in Render Dashboard, delete and recreate.
  # ============================================================================
  - type: web              # ‚úÖ CONFIRMED: Web Service (REQUIRED)
    name: hiremebahamas-backend
    runtime: python        # ‚úÖ CONFIRMED: Python Runtime (REQUIRED)
    region: oregon
    
    # ==========================================================================
    # PLAN SELECTION - Standard plan for ALWAYS ON architecture
    # ==========================================================================
    # STANDARD ($25/mo, 1GB RAM) - REQUIRED FOR FINAL SPEED ARCHITECTURE:
    #   - Always On: Zero cold starts, instant responses
    #   - High Performance: FastAPI + Uvicorn optimized
    #   - Stable: No 502 errors, consistent uptime
    #   - Production-Ready: Suitable for global traffic
    # ==========================================================================
    plan: standard
    
    # Auto-scaling (Standard plan and above)
    scaling:
      minInstances: 1
      maxInstances: 3
      targetCPUPercent: 80
      targetMemoryPercent: 85
    
    # ============================================================================
    # BUILD COMMAND - Install dependencies with Poetry (STEP 18)
    # ============================================================================
    # Poetry provides deterministic builds with poetry.lock file
    # Install production dependencies only (no dev dependencies)
    buildCommand: pip install poetry && poetry install --only=main
    
    # ==========================================================================
    # START COMMAND - PRODUCTION FASTAPI CONFIGURATION
    # ==========================================================================
    # ‚úÖ FINAL "DO NOT EVER DO" LIST COMPLIANT:
    # ‚úÖ Single Gunicorn worker (workers=1)
    # ‚úÖ No blocking DB calls at import
    # ‚úÖ Health check never touches DB
    # ‚úÖ No --reload flag
    # ‚úÖ No heavy startup logic (all async)
    # ‚úÖ Single platform deployment (Render only)
    #
    # EXPECTED LOGS:
    #   ‚úÖ Booting worker with pid ...
    #   ‚úÖ Application startup complete
    #
    # YOU SHOULD NOT SEE:
    #   ‚ùå Worker was sent SIGTERM
    #
    # WHY THIS FIX IS PERMANENT:
    #   ‚Ä¢ Render kills slow starters ‚Üí We start instantly
    #   ‚Ä¢ Gunicorn defaults unsafe ‚Üí We use workers=1
    #   ‚Ä¢ One worker = predictable memory
    #   ‚Ä¢ Async startup = instant health
    #   ‚Ä¢ DB warms after app is alive
    #
    # This is how production FastAPI apps actually run.
    #
    # Working directory: Changes to backend/ where app/main.py and gunicorn.conf.py are located
    startCommand: cd backend && poetry run gunicorn app.main:app --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --workers 1 --timeout 120
    
    envVars:
      - key: ENVIRONMENT
        value: production
      # ==========================================================================
      # SECRET KEYS - IMPORTANT: Set these manually in Render Dashboard
      # ==========================================================================
      # DO NOT use generateValue: true for SECRET_KEY and JWT_SECRET_KEY
      # This causes authentication failures when the service restarts
      # 
      # Generate secrets locally and set in Render Dashboard:
      #   python3 -c "import secrets; print(secrets.token_urlsafe(32))"
      #
      # Set these in Render Dashboard ‚Üí Environment ‚Üí Add Environment Variable
      # ==========================================================================
      # SECRET_KEY - Set manually in Render Dashboard
      # JWT_SECRET_KEY - Set manually in Render Dashboard
      - key: FRONTEND_URL
        value: https://hiremebahamas.vercel.app
      - key: PYTHONUNBUFFERED
        value: "true"
      - key: PYTHON_VERSION
        value: "3.12.0"
      # ==========================================================================
      # PYTHONPATH - Set to backend directory for proper module resolution
      # ==========================================================================
      # This ensures Python can find the app module when working directory is root
      # Aligns with problem statement Option B: Set PYTHONPATH=backend
      - key: PYTHONPATH
        value: backend
      # ==========================================================================
      # NEON POSTGRESQL CONNECTION SETTINGS
      # ==========================================================================
      # Neon provides serverless PostgreSQL with connection pooling
      # Connection string format for Neon:
      # postgresql://user:password@ep-xxxxx.region.aws.neon.tech/dbname?sslmode=require
      # 
      # Required settings for Neon:
      # - sslmode=require: Neon requires SSL/TLS connections
      # - Connection pooling: Neon handles pooling automatically
      # - TCP connection: Direct TCP+SSL connection to Neon
      #
      # Set DATABASE_URL in Render Dashboard Environment Variables:
      # Example: postgresql://user:pass@ep-xxxxx.us-east-1.aws.neon.tech:5432/hiremebahamas?sslmode=require
      # ==========================================================================
      - key: DB_POOL_SIZE
        value: "5"
      - key: DB_MAX_OVERFLOW
        value: "10"
      - key: DB_POOL_TIMEOUT
        value: "30"
      - key: DB_POOL_RECYCLE
        value: "3600"
      - key: DB_ECHO
        value: "false"
      # ==========================================================================
      # GUNICORN PERFORMANCE SETTINGS (Render Optimized - Single Worker)
      # ==========================================================================
      # Optimized for Render small instances (AGGRESSIVE FOREVER FIX)
      # CRITICAL: Render does NOT like many workers on small instances
      # 
      # Configuration:
      # - Workers: 1 (single worker is faster + safer)
      # - Threads: 2 (minimal threading overhead)
      # - Timeout: 120s (prevents worker SIGTERM during slow startup)
      # - Single worker with async event loop handles 100+ concurrent connections
      - key: WEB_CONCURRENCY
        value: "1"
      - key: WEB_THREADS
        value: "2"
      - key: GUNICORN_TIMEOUT
        value: "120"
      - key: KEEPALIVE
        value: "5"
      # Trust Render's load balancer for proxy headers
      - key: FORWARDED_ALLOW_IPS
        value: "*"
      # ==========================================================================
      # REDIS CONFIGURATION (OPTIONAL)
      # ==========================================================================
      # To enable Redis caching for improved performance:
      # 1. In Render Dashboard ‚Üí + New ‚Üí Redis
      # 2. Copy the Internal Redis URL (rediss://...)
      # 3. Add REDIS_URL environment variable in this service's settings
      # 4. The application will automatically use Redis when REDIS_URL is available
      #
      # Benefits of Redis:
      # - 90% faster authentication (10ms ‚Üí <1ms)
      # - 80-90% reduction in database load
      # - Shared cache across multiple instances
      # - Session persistence across restarts
      #
      # Set REDIS_URL manually in Render Dashboard ‚Üí Environment Variables:
      # REDIS_URL: rediss://:password@hostname:port
      #
      # See REDIS_SETUP_GUIDE.md for detailed setup instructions
      # ==========================================================================
    
    # ==========================================================================
    # HEALTH CHECK - FINAL SPEED ARCHITECTURE (Always On)
    # ==========================================================================
    # With Standard plan (Always On), health checks are instant
    # No cold starts, no warm-up needed
    #
    # AVAILABLE ENDPOINTS:
    #   /health      - Instant health check (recommended, no prefix)
    #   /api/health  - Instant health check (alternative with /api prefix)
    #   /ready       - Readiness check with DB connectivity
    #   /live        - Liveness probe
    #
    # ‚ö†Ô∏è  CRITICAL: RENDER DASHBOARD CONFIGURATION
    # ==========================================================================
    # Go to: Render Dashboard ‚Üí Your Backend ‚Üí Settings ‚Üí Health Check
    # 
    # Set ONE of these paths (case-sensitive, must match exactly):
    #   Option 1 (Recommended): Health Check Path: /health
    #   Option 2 (With prefix):  Health Check Path: /api/health
    #
    # Additional Settings:
    #   Grace Period: 60 seconds (minimal - Always On service)
    #   Health Check Timeout: 10 seconds
    #   Health Check Interval: 30 seconds
    #
    # Note: With Always On (Standard plan), no keepalive workers needed!
    # ==========================================================================
    healthCheckPath: /health
