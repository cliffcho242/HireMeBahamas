# =============================================================================
# HireMeBahamas Backend - Render Deployment Configuration
# ‚úÖ CORRECT STACK (2025)
# =============================================================================
# 
# ‚ö° CORRECT STACK - INDUSTRY STANDARD:
# - Frontend: Vercel (CDN, Edge, static & dynamic UI)
# - Backend API: Render (Always-on Gunicorn service)
# - Database: Neon PostgreSQL (managed, scalable)
# 
# This architecture provides:
# - ‚ö° Fast: Global CDN + Always-On backend
# - üîí Stable: No cold starts, no downtime
# - üåç Global: Edge network worldwide
# - üí∞ Scales well: Efficient pricing
# - üß† Industry-standard: Proven tech stack used by Facebook/Twitter scale apps
#
# Configuration:
# - Standard plan ($25/mo) with 1GB RAM for Always On
# - FastAPI with Gunicorn (production WSGI server with Uvicorn workers)
# - Neon PostgreSQL with connection pooling
# - Health check at /health with optimized settings
# 
# Optional Phase 2:
# - Redis (sessions, feeds, caching) - Industry standard for scale
# =============================================================================

services:
  - type: web
    name: hiremebahamas-backend
    runtime: python
    region: oregon
    
    # ==========================================================================
    # PLAN SELECTION - Standard plan for ALWAYS ON architecture
    # ==========================================================================
    # STANDARD ($25/mo, 1GB RAM) - REQUIRED FOR FINAL SPEED ARCHITECTURE:
    #   - Always On: Zero cold starts, instant responses
    #   - High Performance: FastAPI + Uvicorn optimized
    #   - Stable: No 502 errors, consistent uptime
    #   - Production-Ready: Suitable for global traffic
    # ==========================================================================
    plan: standard
    
    # Auto-scaling (Standard plan and above)
    scaling:
      minInstances: 1
      maxInstances: 3
      targetCPUPercent: 80
      targetMemoryPercent: 85
    
    # ============================================================================
    # BUILD COMMAND - Install dependencies
    # ============================================================================
    buildCommand: pip install -r backend/requirements.txt
    
    # ==========================================================================
    # START COMMAND - FastAPI with Gunicorn (STEP 10 - SCALING TO 100K+ USERS)
    # ==========================================================================
    # Gunicorn with Uvicorn workers optimized for 100K+ concurrent users
    # - Gunicorn: Production WSGI server with worker management
    # - Uvicorn workers: ASGI support for FastAPI async operations
    # - Workers: 4 (optimized for 100K+ users with Redis handling most requests)
    # - Threads: 4 per worker (configured in gunicorn.conf.py)
    # - Total capacity: 16 concurrent requests (4 workers √ó 4 threads)
    # - NO --preload: Safer for database apps (each worker loads independently)
    # - Working directory is set to backend/ for consistent path resolution
    # 
    # Expected Performance After Step 10:
    # - Feed: 20-60ms (with Redis caching)
    # - Auth: <50ms
    # - Health: <30ms
    # - DB load: Very low (Redis handles most requests)
    # - Concurrent capacity: 16 requests
    # - Supported users: 100K+ concurrent
    #
    # ‚ö†Ô∏è CRITICAL: This command is a SINGLE LINE with NO backslashes
    # If you see "unrecognized arguments" error, check:
    #   1. Command is on ONE line (no line breaks)
    #   2. No backslashes (\) in the command
    #   3. No extra text after the command
    #   4. See FIX_RENDER_GUNICORN_ERROR.md for help
    startCommand: cd backend && gunicorn app.main:app --workers ${WEB_CONCURRENCY:-4} --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --log-level info
    
    envVars:
      - key: ENVIRONMENT
        value: production
      # ==========================================================================
      # SECRET KEYS - IMPORTANT: Set these manually in Render Dashboard
      # ==========================================================================
      # DO NOT use generateValue: true for SECRET_KEY and JWT_SECRET_KEY
      # This causes authentication failures when the service restarts
      # 
      # Generate secrets locally and set in Render Dashboard:
      #   python3 -c "import secrets; print(secrets.token_urlsafe(32))"
      #
      # Set these in Render Dashboard ‚Üí Environment ‚Üí Add Environment Variable
      # ==========================================================================
      # SECRET_KEY - Set manually in Render Dashboard
      # JWT_SECRET_KEY - Set manually in Render Dashboard
      - key: FRONTEND_URL
        value: https://hiremebahamas.vercel.app
      - key: PYTHONUNBUFFERED
        value: "true"
      - key: PYTHON_VERSION
        value: "3.12.0"
      # ==========================================================================
      # NEON POSTGRESQL CONNECTION SETTINGS
      # ==========================================================================
      # Neon provides serverless PostgreSQL with connection pooling
      # Connection string format for Neon:
      # postgresql://user:password@ep-xxxxx.region.aws.neon.tech/dbname?sslmode=require
      # 
      # Required settings for Neon:
      # - sslmode=require: Neon requires SSL/TLS connections
      # - Connection pooling: Neon handles pooling automatically
      # - TCP connection: Direct TCP+SSL connection to Neon
      #
      # Set DATABASE_URL in Render Dashboard Environment Variables:
      # Example: postgresql://user:pass@ep-xxxxx.us-east-1.aws.neon.tech:5432/hiremebahamas?sslmode=require
      # ==========================================================================
      - key: DB_POOL_SIZE
        value: "5"
      - key: DB_MAX_OVERFLOW
        value: "10"
      - key: DB_POOL_TIMEOUT
        value: "30"
      - key: DB_POOL_RECYCLE
        value: "3600"
      - key: DB_ECHO
        value: "false"
      # ==========================================================================
      # GUNICORN PERFORMANCE SETTINGS (Lightning Fast Configuration)
      # ==========================================================================
      # Optimized for Render Standard plan (always-on, 1GB RAM)
      # Workers: 2 for parallel request handling
      # Threads: 4 per worker = 8 total concurrent requests
      # Timeout: 60s for fast responses without cold start delays
      - key: WEB_CONCURRENCY
        value: "2"
      - key: WEB_THREADS
        value: "4"
      - key: GUNICORN_TIMEOUT
        value: "60"
      - key: KEEPALIVE
        value: "5"
      # Trust Render's load balancer for proxy headers
      - key: FORWARDED_ALLOW_IPS
        value: "*"
    
    # ==========================================================================
    # HEALTH CHECK - FINAL SPEED ARCHITECTURE (Always On)
    # ==========================================================================
    # With Standard plan (Always On), health checks are instant
    # No cold starts, no warm-up needed
    #
    # AVAILABLE ENDPOINTS:
    #   /health      - Instant health check (recommended, no prefix)
    #   /api/health  - Instant health check (alternative with /api prefix)
    #   /ready       - Readiness check with DB connectivity
    #   /live        - Liveness probe
    #
    # ‚ö†Ô∏è  CRITICAL: RENDER DASHBOARD CONFIGURATION
    # ==========================================================================
    # Go to: Render Dashboard ‚Üí Your Backend ‚Üí Settings ‚Üí Health Check
    # 
    # Set ONE of these paths (case-sensitive, must match exactly):
    #   Option 1 (Recommended): Health Check Path: /health
    #   Option 2 (With prefix):  Health Check Path: /api/health
    #
    # Additional Settings:
    #   Grace Period: 60 seconds (minimal - Always On service)
    #   Health Check Timeout: 10 seconds
    #   Health Check Interval: 30 seconds
    #
    # Note: With Always On (Standard plan), no keepalive workers needed!
    # ==========================================================================
    healthCheckPath: /health
