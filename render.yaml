# =============================================================================
# DEPRECATED: HireMeBahamas Backend - Render Deployment Configuration
# =============================================================================
# 
# ⚠️  THIS FILE IS DEPRECATED - MIGRATION TO VERCEL + RAILWAY COMPLETE
# 
# See RENDER_TO_VERCEL_MIGRATION.md for the new architecture:
# - Frontend: Vercel (Edge + Static)
# - Backend: Railway (Python/Flask)
# - Database: Railway PostgreSQL
# - Cost: $0-7/month (vs $25-50/month on Render)
#
# This file is kept for historical reference only.
# DO NOT deploy to Render - all services should be deleted.
#
# OLD CONFIGURATION (for reference):
# - Standard plan ($25/mo) with 1GB RAM
# - Single worker + 180s timeout
# - Health check at /health with 300s grace period
# - Keep-alive background worker pinging every 45s
# =============================================================================

services:
  - type: web
    name: hiremebahamas-backend
    runtime: python
    region: oregon
    
    # ==========================================================================
    # PLAN SELECTION - Standard recommended for zero 502s
    # ==========================================================================
    # STARTER ($7/mo, 512MB RAM):
    #   - Good for low traffic, may have occasional slow cold starts
    #   - Set WEB_CONCURRENCY=1, WEB_THREADS=2
    #
    # STANDARD ($25/mo, 1GB RAM) - RECOMMENDED:
    #   - Always On, no 502s, fast responses
    #   - Set WEB_CONCURRENCY=1, WEB_THREADS=4
    # ==========================================================================
    plan: standard
    
    # Auto-scaling (Standard plan and above)
    scaling:
      minInstances: 1
      maxInstances: 3
      targetCPUPercent: 80
      targetMemoryPercent: 85
    
    # ============================================================================
    # MASTERMIND FIX 2025 — RENDER BUILD COMMAND
    # Forces pip to ONLY use pre-built binary wheels (no compilation)
    # Prevents: "Failed building wheel for asyncpg" + gcc exit code 1 errors
    # Result: <8 second install, zero build errors, works on Render Free tier
    # NO apt-get needed, NO gcc, NO libpq-dev, NO build-essential
    # ============================================================================
    buildCommand: pip install --upgrade pip setuptools wheel && pip install --only-binary=:all: -r requirements.txt
    
    # ==========================================================================
    # START COMMAND - Nuclear Configuration
    # ==========================================================================
    # - workers=1: Prevents OOM on 1GB RAM
    # - timeout=180: Survives Railway DB cold starts (up to 2 min)
    # - keep-alive=5: Matches Render load balancer
    # - preload: Eliminates cold start app loading delay
    # ==========================================================================
    startCommand: gunicorn final_backend_postgresql:application --config gunicorn.conf.py --preload
    
    envVars:
      - key: FLASK_ENV
        value: production
      - key: ENVIRONMENT
        value: production
      - key: SECRET_KEY
        generateValue: true
      - key: FRONTEND_URL
        value: https://hiremebahamas.vercel.app
      - key: PYTHONUNBUFFERED
        value: "true"
      - key: PYTHON_VERSION
        value: "3.12.0"
      # Nuclear configuration - single worker, high timeout
      - key: WEB_CONCURRENCY
        value: "1"
      - key: WEB_THREADS
        value: "4"
      - key: GUNICORN_TIMEOUT
        value: "180"
      - key: GUNICORN_KEEPALIVE
        value: "5"
      - key: PRELOAD_APP
        value: "true"
      # Database keepalive thread
      - key: DB_KEEPALIVE_ENABLED
        value: "true"
      # Trust Render's load balancer
      - key: FORWARDED_ALLOW_IPS
        value: "*"
      # Nuclear pool configuration
      - key: DB_POOL_SIZE
        value: "2"
      - key: DB_CONNECT_TIMEOUT
        value: "45"
      - key: DB_POOL_RECYCLE
        value: "120"
      # DATABASE_URL must be set manually in Render dashboard
      # NUCLEAR FORMAT (URL-encoded spaces and equals):
      # postgresql://user:pass@host:5432/db?sslmode=require&options=-c%20jit%3Doff&connect_timeout=45
      # Alternative (non-encoded):
      # postgresql://user:pass@host:5432/db?sslmode=require&options=-c jit=off&connect_timeout=45
    
    # ==========================================================================
    # HEALTH CHECK - Nuclear Settings (2025 Render Edition)
    # ==========================================================================
    # AVAILABLE ENDPOINTS (all respond in <5ms):
    #   /health  - Instant liveness check, no DB (use for Render health path)
    #   /live    - Kubernetes-style liveness probe, no DB
    #   /ready   - Readiness check with DB connectivity (returns 503 if DB down)
    #   /ready/db - Full DB health with session (use for deep checks)
    #   /ping    - Simple "pong" response for keepalive workers
    #   /metrics - Prometheus metrics (for monitoring)
    #
    # RENDER DASHBOARD SETTINGS (COPY-PASTE):
    #   Health Check Path: /health
    #   Grace Period: 300 seconds (5 min - handles worst-case cold start)
    #   Health Check Timeout: 30 seconds
    #   Health Check Interval: 30 seconds (default)
    #
    # WHY /health AND NOT /ready?
    #   /health responds instantly (<5ms) even during cold starts
    #   /ready checks DB connectivity, which may timeout during cold starts
    #   Using /health prevents Render from killing the container prematurely
    # ==========================================================================
    healthCheckPath: /health

  # ==========================================================================
  # KEEP-ALIVE BACKGROUND WORKER
  # ==========================================================================
  # Pings /health every 45 seconds to prevent cold starts
  # Cost: $0 on Render Free tier for Background Workers
  # ==========================================================================
  - type: worker
    name: keep-alive
    runtime: python
    region: oregon
    plan: free
    buildCommand: pip install requests
    startCommand: python keep_alive.py
    envVars:
      - key: PYTHONUNBUFFERED
        value: "true"
      - key: RENDER_EXTERNAL_URL
        value: https://hiremebahamas.onrender.com

  # ==========================================================================
  # CRON JOB - Backup Keepalive
  # ==========================================================================
  # Pings /health every 5 minutes as backup
  # Uses minimal Docker image (5MB vs full Python)
  # ==========================================================================
  - type: cron
    name: keepalive-ping
    region: oregon
    plan: free
    schedule: "*/5 * * * *"
    dockerImage: curlimages/curl:latest
    dockerCommand: curl -f -s -o /dev/null https://hiremebahamas.onrender.com/health

  # ==========================================================================
  # CACHE WARMING CRON JOB
  # ==========================================================================
  # Pre-warms cache every 5 minutes for sub-100ms responses
  # ==========================================================================
  - type: cron
    name: cache-warmer
    region: oregon
    plan: free
    schedule: "*/5 * * * *"
    dockerImage: curlimages/curl:latest
    dockerCommand: curl -f -s -X POST https://hiremebahamas.onrender.com/warm-cache
