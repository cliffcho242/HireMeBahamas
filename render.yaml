# =============================================================================
# HireMeBahamas Backend - Render Deployment Configuration
# =============================================================================
# 
# QUICK FIX FOR 502 ERRORS:
# The "starter" plan ($7/mo) keeps your service ALWAYS ON - no sleep, no 502s.
# For free tier: Use external pinger (UptimeRobot) to ping /ping every 5 min.
#
# See docs/RENDER_QUICK_START.md for step-by-step instructions
# See docs/RENDER_502_FIX_GUIDE.md for detailed troubleshooting
# See docs/HIGH_AVAILABILITY.md for advanced configuration
# =============================================================================

services:
  - type: web
    name: hiremebahamas-backend
    runtime: python
    region: oregon
    
    # ==========================================================================
    # PLAN SELECTION - Critical for 502 Prevention
    # ==========================================================================
    # 
    # FREE TIER ($0):
    #   - Sleeps after 15 minutes of inactivity
    #   - Causes 502 Bad Gateway on cold start (10-120+ seconds)
    #   - WORKAROUND: Use external pinger (UptimeRobot free tier)
    #
    # STARTER PLAN ($7/month) - RECOMMENDED:
    #   - ALWAYS ON - Never sleeps, no 502 errors ever
    #   - Instant response times (<1 second) even after hours of inactivity
    #   - Best for production job platforms
    #
    # STANDARD PLAN ($25/month):
    #   - Always On + Auto-scaling support
    #   - Best for high-traffic applications
    #
    # To change: Render Dashboard → Your Service → Settings → Instance Type
    # ==========================================================================
    plan: starter
    
    # Auto-scaling configuration (requires Standard plan $25/mo or higher)
    # Render automatically manages scaling based on these thresholds:
    # - When CPU exceeds targetCPUPercent, new instances are added
    # - When memory exceeds targetMemoryPercent, new instances are added
    # - Scaling down occurs after ~5 minutes of reduced load
    scaling:
      minInstances: 1        # Minimum instances (always running)
      maxInstances: 10       # Maximum instances during peak load
      targetCPUPercent: 70   # Scale up when average CPU > 70%
      targetMemoryPercent: 80 # Scale up when average memory > 80%
    
    buildCommand: |
      apt-get update
      apt-get install -y --no-install-recommends \
        build-essential \
        gcc \
        g++ \
        make \
        pkg-config \
        cmake \
        autoconf \
        automake \
        libtool \
        postgresql \
        postgresql-client \
        postgresql-client-common \
        postgresql-common \
        postgresql-contrib \
        libpq-dev \
        libpq5 \
        sqlite3 \
        libsqlite3-dev \
        libsqlite3-0 \
        python3-dev \
        python3-setuptools \
        python3-wheel \
        libssl-dev \
        libffi-dev \
        ca-certificates \
        libjpeg-dev \
        libpng-dev \
        libtiff-dev \
        libwebp-dev \
        zlib1g-dev \
        libfreetype6-dev \
        liblcms2-dev \
        libevent-dev \
        libxml2-dev \
        libxslt1-dev \
        libreadline-dev \
        libbz2-dev \
        libncurses5-dev \
        curl \
        wget \
        git
      pip install --upgrade pip setuptools wheel
      pip install -r requirements.txt
    startCommand: gunicorn final_backend_postgresql:application --config gunicorn.conf.py
    envVars:
      - key: FLASK_ENV
        value: production
      - key: ENVIRONMENT
        value: production
      - key: SECRET_KEY
        generateValue: true
      - key: FRONTEND_URL
        value: https://hiremebahamas.vercel.app
      - key: PYTHONUNBUFFERED
        value: "true"
      - key: PYTHON_VERSION
        value: "3.12.0"
      # High availability: Configure worker concurrency for optimal scaling
      - key: WEB_CONCURRENCY
        value: "2"
      - key: WEB_THREADS
        value: "8"
      # Enable database keepalive thread
      - key: DB_KEEPALIVE_ENABLED
        value: "true"
      # DATABASE_URL must be set manually in Render dashboard
      # to connect to your PostgreSQL database
    
    # ==========================================================================
    # HEALTH CHECK CONFIGURATION
    # ==========================================================================
    # 
    # Available endpoints:
    #   /ping          - Lightweight ping (fastest, no DB, for external pingers)
    #   /health        - Basic health (fast, no DB, used by Render health checks)
    #   /api/health    - Detailed health (includes DB status, for monitoring)
    #
    # External pinger URL: https://hiremebahamas.onrender.com/ping
    # ==========================================================================
    healthCheckPath: /health

  # ==========================================================================
  # KEEP-ALIVE BACKGROUND WORKER
  # ==========================================================================
  # 
  # This background worker pings the web service every 70 seconds to prevent
  # it from sleeping due to inactivity on Render's free tier.
  # 
  # Note: If using the Starter plan ($7/mo), this worker is not necessary
  # as the service is always on. However, it provides additional reliability.
  # ==========================================================================
  - type: worker
    name: keep-alive
    runtime: python
    region: oregon
    plan: free
    buildCommand: pip install requests
    startCommand: python keep_alive.py
    envVars:
      - key: RENDER_EXTERNAL_URL
        value: https://hiremebahamas.onrender.com
      - key: PYTHONUNBUFFERED
        value: "true"
