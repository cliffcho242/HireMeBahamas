# =============================================================================
# HireMeBahamas Render Deployment - NUCLEAR 2025-PROOF EDITION
# =============================================================================
#
# DASHBOARD SETTINGS (copy-paste these):
#   Plan: Standard ($25/mo) or Starter ($7/mo minimum)
#   Health Check Path: /health
#   Health Check Timeout: 30 seconds
#   Grace Period: 300 seconds (5 minutes)
#   Instance Memory: 1GB (Standard) or 512MB (Starter)
#
# PERFORMANCE TARGETS:
#   - Boot time: < 9 seconds
#   - First request: < 400ms
#   - Login: < 180ms (cached)
#   - Zero 502/499/timeout/OOM forever
#
# COST: < $60/mo total (Standard $25 + DB $7 + domain $0)
# =============================================================================

services:
  # ==========================================================================
  # WEB SERVICE - Backend API
  # ==========================================================================
  - type: web
    name: hiremebahamas-backend
    runtime: python
    region: oregon
    
    # Standard plan ($25/mo, 1GB RAM) - RECOMMENDED for zero 502s
    # Starter plan ($7/mo, 512MB RAM) - Budget option, may have slow cold starts
    plan: standard
    
    # Auto-scaling configuration
    scaling:
      minInstances: 1
      maxInstances: 3
      targetCPUPercent: 80
      targetMemoryPercent: 85
    
    # Build command - install system dependencies + Python packages
    buildCommand: |
      apt-get update
      apt-get install -y --no-install-recommends \
        build-essential \
        libpq-dev \
        python3-dev
      pip install --upgrade pip setuptools wheel
      pip install -r requirements.txt
    
    # Start command - nuclear gunicorn configuration
    startCommand: gunicorn final_backend_postgresql:application --config gunicorn.conf.py --preload
    
    # Environment variables
    envVars:
      - key: FLASK_ENV
        value: production
      - key: ENVIRONMENT
        value: production
      - key: SECRET_KEY
        generateValue: true
      - key: FRONTEND_URL
        value: https://hiremebahamas.vercel.app
      - key: PYTHONUNBUFFERED
        value: "true"
      - key: PYTHON_VERSION
        value: "3.12.0"
      # Nuclear worker configuration
      - key: WEB_CONCURRENCY
        value: "1"
      - key: WEB_THREADS
        value: "4"
      - key: GUNICORN_TIMEOUT
        value: "120"
      - key: GUNICORN_KEEPALIVE
        value: "5"
      - key: PRELOAD_APP
        value: "true"
      # Database keepalive
      - key: DB_KEEPALIVE_ENABLED
        value: "true"
      # Trust Render's load balancer
      - key: FORWARDED_ALLOW_IPS
        value: "*"
      # DATABASE_URL must be set manually in Render dashboard
      # Format: postgresql://user:pass@host:5432/db?connect_timeout=10&options=-c%20jit%3Doff
    
    # ==========================================================================
    # HEALTH CHECK - Nuclear Settings
    # ==========================================================================
    # Path: /health (instant response, no DB check)
    # This endpoint responds in <5ms even on coldest start
    healthCheckPath: /health

  # ==========================================================================
  # KEEP-ALIVE BACKGROUND WORKER
  # ==========================================================================
  # Pings /health every 45 seconds to prevent cold starts
  # Cost: $0 on Render Free tier for Background Workers
  - type: worker
    name: keep-alive
    runtime: python
    region: oregon
    plan: free
    buildCommand: pip install requests
    startCommand: python keep_alive.py
    envVars:
      - key: PYTHONUNBUFFERED
        value: "true"

  # ==========================================================================
  # CRON JOB - Backup Keepalive
  # ==========================================================================
  # Pings /health every 5 minutes as backup
  - type: cron
    name: keepalive-ping
    region: oregon
    plan: free
    schedule: "*/5 * * * *"
    dockerImage: curlimages/curl:latest
    dockerCommand: curl -f -s -o /dev/null https://hiremebahamas.onrender.com/health

  # ==========================================================================
  # CACHE WARMING CRON JOB
  # ==========================================================================
  # Pre-warms cache every 5 minutes for sub-100ms responses
  - type: cron
    name: cache-warmer
    region: oregon
    plan: free
    schedule: "*/5 * * * *"
    dockerImage: curlimages/curl:latest
    dockerCommand: curl -f -s -X POST https://hiremebahamas.onrender.com/warm-cache
