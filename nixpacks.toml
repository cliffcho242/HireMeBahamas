# Force Python provider only - prevents Node.js detection
providers = ["python"]

# Build-time variables only (non-sensitive)
# IMPORTANT: NEVER add sensitive data (keys, secrets, passwords) here
# ❌ BAD:  [variables]
# ❌ BAD:  SECRET_KEY = "my-secret"          # This gets baked into image layers!
# ❌ BAD:  JWT_SECRET_KEY = "jwt-secret"     # Visible in image history!
# ✅ GOOD: Configure secrets in your deployment platform's dashboard as environment variables
# ✅ GOOD: They will be injected at runtime, not build time
[variables]
NIXPACKS_NO_MUSL = "1"
PYTHON_VERSION = "3.12"

# Security: Sensitive variables should only be available at runtime via platform environment injection
# The phases configuration ensures packages are installed without exposing secrets
[phases.setup]
# Comprehensive system packages for production deployment with PostgreSQL
# 
# ⚠️ CRITICAL WARNING ABOUT POSTGRESQL:
# -----------------------------------
# We install postgresql-client and libpq-dev for DATABASE CONNECTIVITY ONLY.
# These are CLIENT libraries to CONNECT to managed PostgreSQL databases (Neon, Render, etc.).
# 
# DO NOT INSTALL: postgresql, postgresql-16, postgresql-server, or any PostgreSQL server packages
# DO NOT DEPLOY: PostgreSQL as a container on the same service as the backend
# 
# Use managed PostgreSQL databases (Neon, Render, etc.). See .env.example for database setup instructions.
# If you see "root execution of the PostgreSQL server is not permitted" error,
# you have misconfigured your deployment. Use a managed database service instead.
#
aptPkgs = [
    # Build tools (required for compiling Python packages)
    "build-essential",
    "gcc",
    "g++",
    "make",
    "pkg-config",
    
    # PostgreSQL CLIENT libraries ONLY (for connecting to managed databases)
    # ⚠️ These are NOT server packages - they're client libraries for database connectivity
    # Managed PostgreSQL services (Neon, Render, etc.) handle the actual database server
    "postgresql-client",
    "libpq-dev",
    "libpq5",
    
    # Python development headers (required for building Python C extensions)
    "python3-dev",
    
    # SSL/TLS libraries (required for cryptography package and secure PostgreSQL connections)
    "libssl-dev",
    "libffi-dev",
    "ca-certificates",
    
    # Image processing libraries (for Pillow if used)
    "libjpeg-dev",
    "libpng-dev",
    "libtiff-dev",
    "libwebp-dev",
    "zlib1g-dev",
    "libfreetype6-dev",
    "liblcms2-dev",
    
    # Event notification library (for gevent and async operations)
    "libevent-dev",
    
    # XML processing libraries (for various packages)
    "libxml2-dev",
    "libxslt1-dev",
    
    # SQLite libraries (for aiosqlite in development/testing)
    "sqlite3",
    "libsqlite3-dev",
    "libsqlite3-0",
    
    # Additional libraries for Python packages
    "libreadline-dev",
    "libbz2-dev",
    "libncurses5-dev",
    "libncursesw5-dev",
    "tk-dev",
    "xz-utils",
    "llvm",
    
    # Redis tools (for connectivity testing if Redis is used)
    "redis-tools",
    
    # Utilities for debugging and monitoring
    "curl",
    "wget",
    "git",
    "vim",
    "net-tools"
]

# Secrets should be configured via platform environment variables, NOT in Dockerfile
# Do not use ARG or ENV for: SECRET_KEY, JWT_SECRET_KEY, API keys, passwords, etc.
# Platform services (Render, Vercel, etc.) inject secrets at runtime

# Explicitly install Python dependencies using Poetry (STEP 18)
[phases.install]
cmds = [
    "python -m pip install --upgrade pip",
    "pip install poetry",
    "poetry install --only=main"
]

[start]
# NEON SAFE GUNICORN CONFIGURATION (Render)
# ✅ Correct command for FastAPI with Neon Postgres:
# - app.main:app - FastAPI application entry point  
# - -k uvicorn.workers.UvicornWorker - ASGI worker for async FastAPI
# - --bind 0.0.0.0:$PORT - Bind to all interfaces (Render provides PORT)
# - --workers 1 - One worker for production (Master Playbook requirement)
# - --timeout 120 - Prevents premature worker termination
# ❌ NO extra flags (no sslmode, no statement_timeout)
cmd = "cd backend && poetry run gunicorn app.main:app -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:${PORT:-10000} --workers 1 --threads 2 --timeout 120 --graceful-timeout 30 --keep-alive 5 --max-requests 1000 --max-requests-jitter 100"
