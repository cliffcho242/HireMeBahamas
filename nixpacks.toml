# Force Python provider only - prevents Node.js detection
providers = ["python"]

# Build-time variables only (non-sensitive)
# IMPORTANT: NEVER add sensitive data (keys, secrets, passwords) here
[variables]
NIXPACKS_NO_MUSL = "1"
PYTHON_VERSION = "3.12"

# ============================================================================
# MASTERMIND FIX 2025 — BINARY WHEELS ONLY (NO COMPILATION)
# Removed: build-essential, gcc, g++, make, pkg-config, libpq-dev, python3-dev
# Why: asyncpg 0.29.0 has pre-built wheels for all platforms
# Result: Faster builds, smaller images, zero build errors
# 
# NOTE: If binary wheels are unavailable for your platform/architecture:
# 1. Use requirements-psycopg.txt instead (has wheels for ALL platforms)
# 2. Or add back build tools temporarily (see git history for full list)
# ============================================================================
[phases.setup]
# Runtime dependencies only - NO build tools needed
aptPkgs = [
    # PostgreSQL client libraries (runtime only, NOT dev packages)
    "postgresql-client",
    "libpq5",
    
    # SSL/TLS libraries (for secure connections)
    "ca-certificates",
    
    # SQLite libraries (for aiosqlite if used)
    "sqlite3",
    "libsqlite3-0",
    
    # Utilities for debugging and monitoring
    "curl",
    "wget"
]

# ============================================================================
# MASTERMIND FIX 2025 — PIP INSTALL WITH BINARY WHEELS ONLY
# ============================================================================
[phases.install]
cmds = [
    "pip install --upgrade pip setuptools wheel",
    "pip install --only-binary=:all: -r requirements.txt"
]

[start]
# Migration runs automatically in final_backend_postgresql.py
# PostgreSQL connection is configured via DATABASE_URL environment variable
# Use gunicorn config file which properly reads PORT from environment with fallback to 8080
cmd = "gunicorn final_backend_postgresql:application --config gunicorn.conf.py"
